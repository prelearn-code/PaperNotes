# 论文复现实验方案设计
## 一、实验数据
现在我自己设计的新的数据库，现在设计了一个数据库database1,同时这个数据库配对一个json文件，包含文件名字与文件的关键词，下面是生成的关键词与对应的文件。
```JSON
{

  "/home/zsw/codes/Audit-and-Integrity/make_data/database1/requisite/4.": "software",

  "/home/zsw/codes/Audit-and-Integrity/make_data/database1/requisite/2.": "cross-sell",

  "/home/zsw/codes/Audit-and-Integrity/make_data/database1/requisite/3.": "requisite",

  "/home/zsw/codes/Audit-and-Integrity/make_data/database1/human_resources/1.": "benefits",

  "/home/zsw/codes/Audit-and-Integrity/make_data/database1/requisite/1.": "cross-sell"
}
```

## 三、实验流程设计

### 3.1 阶段一：Setup（系统初始化）

**测试指标：**

1. 存储节点setup时间
2. 公共参数上链gas成本
3. 测试用户端的本地参数生成。

**测试步骤：**

```
1. 存储节点调用 setup_cryptography()
2. 记录执行时间
3. 保存公共参数到 public_params.json
4. 计算公共参数大小
5. 模拟上链，计算gas成本 = size * GAS_PRICE_PER_BYTE
```

**我的评价：**

这个单独设置一个文件进行测试，现在我先用一对客户端与服务端进行后面的操作。
这个模块测试单独设计一个文件，来专门测试这个模块的效率与参数生成时间。
完善一下这个阶段，加上不同节点的初始化的时间与初始化的数据的gas大小。
这个部分主要是测量上链的数据与公共参数还有指定数目个客户端的参数生成的时间与参数的大小与gas的大小。
### 3.2 阶段二：Data Outsourcing（数据外包）

**客户端测试指标：**

**计算开销**
1. 文件读取时间
2. 文件加密时间
3. 认证标签生成时间
4. 关键词关联标签生成时间
5. 总计算时间
**通信开销**
6. 总通信开销（上传数据大小）
7. 单独计算时间。

**服务端测试指标：**
**计算开销**
8. 索引数据库构建时间
9. 搜索数据库构建时间
10. 文件存储时间
11. 总计算时间
**通信开销**
12. 计算通信时间，接收到客户端传输的数据的时间。
**Gas成本：**

这一步没有gas成本。

**阶段评价**
通过我新修改的方案内容，进行修改下面的测试步骤。

**测试步骤：**

```
FOR each file in dataset:
    客户端：
        T1_start = current_time()
        1. 读取文件内容
        2. 生成文件ID
        3. 加密文件 (AES-256)
        4. 生成认证标签 TSF
        5. 生成关键词关联标签 kt(wi)
        6. 生成状态关联指针 ptr
        T1_end = current_time()
        client_time = T1_end - T1_start
        
        upload_size = |ciphertext| + |TSF| + |kt| + |ptr|
        
    服务端：
        T2_start = current_time()
        7. 接收数据
        8. 插入索引数据库
        9. 插入搜索数据库
        10. 保存加密文件
        T2_end = current_time()
        server_time = T2_end - T2_start
        
    Gas计算：
        storage_event_gas = calculate_gas(file_id + metadata)
        index_gas = num_keywords * calculate_gas(index_entry)
END FOR
```

### 3.3 阶段三：Verifiable Search and Integrity Auditing（可验证搜索和完整性审计）

**客户端测试指标：**

1. 生成搜索Token时间
	1. 对于关键词加密与关键词最新状态的取出的时间之和。
2. 发布搜索请求gas成本
	1. 计算前面得到的加密关键词大小与最新状态大小对应的eth中的gas大小。

**服务端测试指标：**

1. 关键词搜索时间
2. 生成关键词关联证明时间
3. 总计算时间
4. 证明上链gas成本

**验证节点测试指标：**

1. 搜索结果验证时间


**证明大小：**
下面就是得到的计算数据，计算这个数据内容的大小不要计算json文件的大小。然后计算gas的大小。
```JSON
{

    "AS" :

    [

        "87094614058280367944197067298160483837574099610829719070026673994548219057539",

        "11515076367749919609355986739994539388434331885952547291777876115998646000575"

    ],

    "PS" :

    [

        {

            "ID_F" : "87094614058280367944197067298160483837574099610829719070026673994548219057539",

            "phi_alpha" : "2a9c8f3ce7a9cd1b1020ee1209b7cc42d563420cd80066db2bb2edc5af8efe3eafa4536888bf4086f91ce587c05e8f6b48c6f5cb8bf6cde9fa9c07a7c945bd6e336b3a510fab39713031776fbe26a36de364dc1cc5b7d000aae7ccc3920a3a1680e3a9bb610707c7a42257d2e434b1c5c678efdf483154eac6ae93ca3b2a0889",

            "psi_alpha" : "237cbb32829e5c5d4112a8f1aede9d012fb0490f"

        },

        {

            "ID_F" : "11515076367749919609355986739994539388434331885952547291777876115998646000575",

            "phi_alpha" : "4f02d8963841b510a8234144f033fbd8749d6753a20fde5fc1e0693a6388144cccf595fedeb8c3d34182b8c74ffa0280afadc3bedb51ac3edd3a6dcb46547842368c5d00f995ffe6b145a8c79cb08c465d757a63b08d882fac9b98bc852459f91ea1ae97a5054255ebe71894fe51c58ee2d93a1f4af1ea51054fa0d59da7ca7a",

            "psi_alpha" : "54258a4d0c09e241104dd05c765a0b2497159d24"

        }

    ],

    "T" : "08c3650143df77535db0d09e8a4457276026d417cc7a0688167236ad0d5d16bd",

    "phi" : "240c388800d3be300d3160c34348db4bd4e19f827053517afc1f8067cf6b362215e7b538cacfeb1c133847de7c6ac1dfe3b5ff6b4b639610534f45cac292c4eb594d033efdb2dc58b5f44cdf3058f28d7a01cc0c182b6f5342d6b78bf5b1dcdb41b43db784723ecce6e5f8ba3f4799afdbfa462f3c6dcaa737351a7b19a9ca33",

    "seed" : "a53a2748eb4d915624baf4aadb29171b4d7fad560a9ea6713bc51016031acc93",

    "std" : "3997cd976badb0630cfb1cc310079557024f1638eb70ac48e6c8b37fb66a33ff"

}
```
**测试步骤：**

根据上面的步骤，修改下面的测试步骤，其中搜索证明与文件完整性证明是一个关键词关联搜索证明生成就可以完整，文件完整性测试函数不用使用。

```
FOR each keyword in keyword_set:
    客户端：
        T_client_start = current_time()
        1. 生成搜索Token T = Enc(mk, keyword)
        2. 获取最新状态 st_d
        3. 发布(T, st_d)到区块链
        T_client_end = current_time()
        client_search_time = T_client_end - T_client_start
        search_request_gas = calculate_gas(T + st_d)
        
    服务端：
        T_server_start = current_time()
        4. 接收(T, st_d)
        5. 执行Search算法：
           - 通过指针链恢复所有文件ID
           - 对每个匹配文件生成(ID_F, w_a, u_a)
           - 计算统一证明 u
        6. 生成关键词关联证明 PS = {(ID_Fa, w_a, u_a), u}
        T_server_end = current_time()
        server_search_time = T_server_end - T_server_start
        
        proof_size = |PS|
        proof_gas = calculate_gas(PS + Res)
        
    验证节点：
        T_verify_start = current_time()
        7. 验证搜索结果正确性和文件完整性（Verify.Search）
        8. 验证其他未搜索文件完整性（Verify.Audit）
        T_verify_end = current_time()
        verify_time = T_verify_end - T_verify_start
END FOR
```

## 四、通信开销测试方案

### 4.1 方案A：模拟网络通信（推荐）我选择这个

**实现方式：**

```cpp
// 基于数据大小和假设带宽计算传输时间
double calculate_transfer_time(size_t data_size, double bandwidth_mbps = 20.0) {
    // data_size: 字节
    // bandwidth_mbps: Mbps (论文中使用20Mbps)
    double data_size_mb = data_size / (1024.0 * 1024.0);
    double transfer_time_seconds = (data_size_mb * 8) / bandwidth_mbps;
    return transfer_time_seconds;
}
```

**优点：**

- 无需真实网络环境
- 结果可复现
- 与论文实验条件一致

**记录数据：**

- 上传数据大小（客户端→服务端）
- 下载数据大小（服务端→客户端）
- 理论传输时间 = 数据大小 / 带宽

### 4.2 方案B：实际网络测试（可选）

如果有真实网络环境，可以：

1. 部署客户端和服务端在不同机器
2. 使用Socket通信
3. 测量实际传输时间

**实现伪代码：**

```cpp
// 客户端发送
T_send_start = current_time();
socket.send(data);
T_send_end = current_time();
upload_time = T_send_end - T_send_start;

// 服务端接收
T_recv_start = current_time();
data = socket.recv();
T_recv_end = current_time();
download_time = T_recv_end - T_recv_start;
```

### 4.3 推荐方案（混合模式）

**客户端→服务端（Data Outsourcing）：**

- 记录：加密文件大小 + 元数据大小
- 计算：理论传输时间 = 总大小 / 20Mbps

**服务端→客户端（Search Results）：**

- 记录：搜索结果大小 + 证明大小
- 计算：理论传输时间 = 总大小 / 20Mbps

## 五、Gas费用计算方案

### 5.1 Gas计算模型（基于Ethereum） 选择这个

```cpp
// 基于论文中的gas计算方法
struct GasCalculator {
    // Ethereum gas价格（Gwei）
    const double GAS_PRICE_GWEI = 50.0;
    
    // 存储操作gas成本（每字节）
    const int SSTORE_GAS_PER_BYTE = 625; // Ethereum SSTORE成本
    
    // 计算存储操作gas
    long long calculate_storage_gas(size_t data_size) {
        return data_size * SSTORE_GAS_PER_BYTE;
    }
    
    // 计算总成本（ETH）
    double calculate_cost_eth(long long total_gas) {
        return (total_gas * GAS_PRICE_GWEI) / 1e9;
    }
};
```

### 5.2 需要计算Gas的操作

1. **Setup阶段：**
    
    - 公共参数上链：`gas = |N| + |g| + |μ|`
2. **Data Outsourcing阶段：**
    
    - 每个文件存储事件：`gas = |file_id| + |metadata|`
    - 每个关键词索引：`gas = |Ti_bar| + |ptr| + |kt|`
3. **Search阶段：**
    
    - 搜索请求：`gas = |T| + |st_d|`
    - 搜索证明：`gas = |PS| + |Res|`


# 根据上面的方案修改下面的内容

## 六、自动化测试脚本设计


### 6.1 测试工具类结构

```cpp
class PerformanceTest {
private:
    // 计时器
    std::chrono::high_resolution_clock::time_point timer_start;
    
    // 结果记录
    struct TestResult {
        double client_process_time;      // 客户端处理时间(ms)
        double server_process_time;      // 服务端处理时间(ms)
        double verify_time;              // 验证时间(ms)
        size_t upload_data_size;         // 上传数据大小(bytes)
        size_t download_data_size;       // 下载数据大小(bytes)
        double upload_transfer_time;     // 上传传输时间(s)
        double download_transfer_time;   // 下载传输时间(s)
        long long total_gas;             // 总gas消耗
        double total_cost_eth;           // 总成本(ETH)
        size_t proof_size;               // 证明大小(bytes)
    };
    
public:
    // 开始计时
    void start_timer();
    
    // 停止计时并返回毫秒
    double stop_timer_ms();
    
    // 计算数据大小
    size_t calculate_data_size(const std::string& data);
    
    // 计算传输时间
    double calculate_transfer_time(size_t size, double bandwidth_mbps);
    
    // 计算gas成本
    long long calculate_gas(size_t data_size);
    
    // 保存结果到JSON
    bool save_results(const std::string& output_file);
};
```

### 6.2 数据生成器

```cpp
class DatasetGenerator {
public:
    // 生成测试数据集
    bool generate_dataset(
        const std::string& output_dir,
        int num_files,
        int keywords_per_file,
        const std::vector<std::string>& keyword_pool
    );
    
private:
    // 生成随机文本文件
    std::string generate_random_text(int size_kb);
    
    // 从文件提取关键词
    std::vector<std::string> extract_keywords(
        const std::string& content,
        int num_keywords
    );
};
```

### 6.3 测试执行器

```cpp
class ExperimentRunner {
public:
    // 运行完整实验
    bool run_full_experiment(
        const std::string& dataset_path,
        const std::string& output_dir
    );
    
private:
    // Phase 1: Setup测试
    TestResult test_setup();
    
    // Phase 2: Data Outsourcing测试
    TestResult test_data_outsourcing(const std::vector<std::string>& files);
    
    // Phase 3: Search测试
    TestResult test_verifiable_search(const std::vector<std::string>& keywords);
    
    // 批量测试
    std::vector<TestResult> batch_test_search(
        const std::vector<std::string>& keywords
    );
};
```

## 七、输出结果格式

### 7.1 实验结果JSON格式

```json
{
  "experiment_info": {
    "dataset": "DB1",
    "num_files": 4108,
    "num_keyword_pairs": 4108,
    "total_size_mb": 8.24,
    "timestamp": "2025-01-15T10:30:00Z"
  },
  
  "phase1_setup": {
    "time_ms": 1523.45,
    "gas_cost": 145678,
    "cost_eth": 0.00728
  },
  
  "phase2_data_outsourcing": {
    "client": {
      "total_time_ms": 45678.90,
      "avg_time_per_file_ms": 11.12,
      "file_encryption_time_ms": 23456.78,
      "tag_generation_time_ms": 22222.12,
      "upload_data_size_mb": 12.45,
      "upload_transfer_time_s": 4.98
    },
    "server": {
      "total_time_ms": 34567.89,
      "avg_time_per_file_ms": 8.42,
      "index_build_time_ms": 20123.45,
      "file_storage_time_ms": 14444.44,
      "download_data_size_mb": 12.45,
      "download_transfer_time_s": 4.98
    },
    "gas_cost": {
      "total_gas": 2345678,
      "cost_eth": 0.11728
    }
  },
  
  "phase3_verifiable_search": {
    "test_cases": [
      {
        "keyword": "technology",
        "num_matched_files": 45,
        "client_time_ms": 12.34,
        "server_time_ms": 234.56,
        "verify_time_ms": 123.45,
        "proof_size_bytes": 4567,
        "result_size_bytes": 890,
        "gas_cost": 12345,
        "cost_eth": 0.000617
      }
    ],
    "summary": {
      "avg_client_time_ms": 11.23,
      "avg_server_time_ms": 221.34,
      "avg_verify_time_ms": 115.67,
      "avg_proof_size_bytes": 4321,
      "total_gas": 234567,
      "total_cost_eth": 0.01173
    }
  }
}
```

### 7.2 对比表格输出

生成CSV文件便于绘图：

**setup_results.csv:**

```
Scheme,Time(ms),Gas,Cost(ETH)
OurScheme,1523.45,145678,0.00728
Baseline1,1678.90,187654,0.00938
Baseline2,1456.78,123456,0.00617
```

**data_outsourcing_results.csv:**

```
Dataset,Client_Time(ms),Server_Time(ms),Gas,Upload_Size(MB),Transfer_Time(s)
DB1,45678.90,34567.89,2345678,12.45,4.98
DB2,123456.78,98765.43,7654321,34.56,13.82
DB3,567890.12,456789.01,34567890,145.67,58.27
```

**search_results.csv:**

```
Keyword,Matched_Files,Client_Time(ms),Server_Time(ms),Verify_Time(ms),Proof_Size(bytes),Gas
technology,45,12.34,234.56,123.45,4567,12345
science,67,15.67,345.67,145.67,5678,15678
business,89,18.90,456.78,167.89,6789,18901
```

## 八、测试代码组织结构

```
experiment/
├── src/
│   ├── performance_test.h          # 性能测试主类
│   ├── performance_test.cpp
│   ├── dataset_generator.h         # 数据集生成器
│   ├── dataset_generator.cpp
│   ├── gas_calculator.h            # Gas计算器
│   ├── gas_calculator.cpp
│   └── experiment_runner.h         # 实验执行器
│       experiment_runner.cpp
│
├── test_data/                      # 测试数据
│   ├── DB1/                        # 小规模数据集
│   ├── DB2/                        # 中规模数据集
│   ├── DB3/                        # 大规模数据集
│   └── keywords.txt                # 关键词库
│
├── results/                        # 实验结果
│   ├── setup_results.json
│   ├── outsourcing_results.json
│   ├── search_results.json
│   └── comparison_tables.csv
│
└── scripts/
    ├── generate_datasets.sh        # 生成数据集脚本
    ├── run_experiments.sh          # 运行实验脚本
    └── plot_results.py             # 绘图脚本（Python）
```

## 九、实验执行流程

### 9.1 准备阶段

```bash
# 1. 生成测试数据集
./scripts/generate_datasets.sh

# 2. 初始化存储节点
./storage_node --setup --output public_params.json

# 3. 初始化客户端
./client --init --params public_params.json
```

### 9.2 执行实验

```bash
# 运行完整实验（包含三个阶段）
./experiment_runner --dataset DB1 --output results/

# 或分阶段运行
./experiment_runner --phase setup --output results/
./experiment_runner --phase outsourcing --dataset DB1 --output results/
./experiment_runner --phase search --keywords keywords.txt --output results/
```

### 9.3 结果分析

```bash
# 生成对比表格
python scripts/generate_tables.py results/

# 绘制性能图表
python scripts/plot_results.py results/
```

## 十、关键注意事项

### 10.1 时间测量精度

- 使用 `std::chrono::high_resolution_clock`
- 每个测试重复3-5次取平均值
- 排除系统I/O抖动影响

### 10.2 内存管理

- 大规模测试时注意内存释放
- DB3测试可能需要分批处理
- 及时清理临时文件

### 10.3 结果可复现性

- 固定随机种子
- 记录完整实验环境信息（CPU、内存、OS）
- 保存中间数据便于调试

### 10.4 与论文对比

- 确保数据集规模一致
- 使用相同的安全参数（512-bit）
- Gas计算模型与Ethereum一致

---

**方案审核要点：** ✅ 是否覆盖论文所有测试指标？ ✅ 数据集生成方案是否可行？ ✅ 通信开销计算是否合理？ ✅ Gas费用模型是否准确？ ✅ 自动化程度是否满足需求？ ✅ 结果输出格式是否便于分析？